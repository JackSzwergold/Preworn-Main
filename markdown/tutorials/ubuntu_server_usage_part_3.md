# Using an Ubuntu Linux Server

Written by [Jack Szwergold][1] on April 6, 2014

## Part 3: Monitoring & Securing Your Ubuntu Server

In part 3 of my tutorial I will explain how to setup useful monitoring & security tools. You should never be in a situation where you cannot be able to review & assess server health. Being able to monitor & secure your server is the key to running a safe & stable server environment. 

### Install the ‘iptables’ firewall.

First we’re going to install `iptables`, which is an excellent & widely used software-based firewall.  We’ll also be installing `iptables-persistent` which is a simply companion tool that allows `iptables` to be reloaded & active if/when a server reboots:

    sudo aptitude install iptables iptables-persistent

Next, we’re going to create a very basic set of `iptables` rules to start off with. Below is a simple `iptables` rule set export of a basic setup I like to use:

    # Generated by iptables-save v1.4.12 on Sun Apr  6 11:50:24 2014
    *nat
    :PREROUTING ACCEPT [0:0]
    :INPUT ACCEPT [0:0]
    :OUTPUT ACCEPT [3:198]
    :POSTROUTING ACCEPT [3:198]
    COMMIT
    # Completed on Sun Apr  6 11:50:24 2014
    # Generated by iptables-save v1.4.12 on Sun Apr  6 11:50:24 2014
    *mangle
    :PREROUTING ACCEPT [22:1475]
    :INPUT ACCEPT [22:1475]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [21:3342]
    :POSTROUTING ACCEPT [21:3342]
    COMMIT
    # Completed on Sun Apr  6 11:50:24 2014
    # Generated by iptables-save v1.4.12 on Sun Apr  6 11:50:24 2014
    *filter
    :INPUT ACCEPT [0:0]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [21:3342]
    :SSH_CHECK - [0:0]
    -A INPUT -p tcp -m tcp --dport 22 -m state --state NEW -j SSH_CHECK
    -A INPUT -i lo -j ACCEPT
    -A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
    -A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
    -A INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
    -A INPUT -p esp -j ACCEPT
    -A INPUT -p ah -j ACCEPT
    -A INPUT -d 224.0.0.251/32 -p udp -m udp --dport 5353 -j ACCEPT
    -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
    -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
    -A INPUT -j REJECT --reject-with icmp-host-prohibited
    -A FORWARD -j TOR
    -A SSH_CHECK -m recent --set --name SSH --rsource
    -A SSH_CHECK -m recent --update --seconds 60 --hitcount 4 --name SSH --rsource -j DROP
    COMMIT
    # Completed on Sun Apr  6 11:50:24 2014

It seems like there is a lot of stuff happening here—and there is—but it’s pretty simple. Here’s a somewhat quick, but wordy explanation but if you don’t need these kind of details just yet, just move onto the next part: The stuff in `*nat` & `*mangle` are boilerplate defaults from an iptables rule set export. The stuff in `*filter` is where the basic cool stuff happens. The important lines in there includes the `SSH_CHECK` which protects against someone “war dialing” your SSH connection. It’s called as part of the `INPUT` chain at the top of the list, but it’s behavior is defined near the bottom of the list. The next set of rules define other sundry `INPUT` points, but the ones you should care about are the rules connected to port `80` as well as `443`. Those open up port `80` which is the basic `http` protocol port used by web servers & port `443` which is used by the `https` protocol used for secure webpage connections. If you need to open up any additional ports on your server, just copy the basic format shown in those two lines & change the port number to match the desired port number you need to have opened.

Now, run this command to immediately load the rules in `iptables.conf` into your server’s `iptables` setup:

    sudo iptables-restore < iptables.conf

Now if you run the following command:

    sudo iptables -L -n

You should see output that looks something like this which reflects all currently active `iptables` rules:

    Chain INPUT (policy ACCEPT)
    target     prot opt source               destination         
    ACCEPT     tcp  --  50.14.92.170         0.0.0.0/0            tcp dpt:22
    SSH_CHECK  tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:22 state NEW
    TOR        all  --  0.0.0.0/0            0.0.0.0/0           
    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:443
    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype 255
    ACCEPT     esp  --  0.0.0.0/0            0.0.0.0/0           
    ACCEPT     ah   --  0.0.0.0/0            0.0.0.0/0           
    ACCEPT     udp  --  0.0.0.0/0            224.0.0.251          udp dpt:5353
    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22
    REJECT     all  --  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited

    Chain FORWARD (policy ACCEPT)
    target     prot opt source               destination         
    TOR        all  --  0.0.0.0/0            0.0.0.0/0           

    Chain OUTPUT (policy ACCEPT)
    target     prot opt source               destination         

    Chain SSH_CHECK (1 references)
    target     prot opt source               destination         
           all  --  0.0.0.0/0            0.0.0.0/0            recent: SET name: SSH side: source
    DROP       all  --  0.0.0.0/0            0.0.0.0/0            recent: UPDATE seconds: 60 hit_count: 4 name: SSH side: source

Which is great! But the issue is that if you restart you server, all of your rules will be gone. That is where `iptables-persistent` comes in. And using it is pretty simple.

Just copy the `iptables.conf` file you created just now into `/etc/iptables/rules.v4`:

    sudo cp ~/iptables.conf /etc/iptables/rules.v4

Now when your server restarts, `iptables-persistent` will load all of the rules stored in `/etc/iptables/rules.v4`so your `iptables` rule set will always be active.

[1]: http://www.preworn.com/ "Preworn • Jack Szwergold’s Online Portfolio"